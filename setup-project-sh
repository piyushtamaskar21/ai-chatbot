#!/bin/bash
# setup-project.sh - Automated repository setup script
# Usage: bash setup-project.sh

set -e  # Exit on error

echo "ðŸš€ Starting AI Chatbot Project Setup..."
echo "=========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check prerequisites
check_prerequisites() {
    echo -e "${YELLOW}ðŸ“‹ Checking prerequisites...${NC}"
    
    # Check Python
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}âŒ Python 3 not found. Please install Python 3.11+${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… Python $(python3 --version)${NC}"
    
    # Check Node.js
    if ! command -v node &> /dev/null; then
        echo -e "${RED}âŒ Node.js not found. Please install Node.js 16+${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… Node.js $(node --version)${NC}"
    
    # Check npm
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}âŒ npm not found. Please install npm${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… npm $(npm --version)${NC}"
}

# Create directory structure
create_directories() {
    echo -e "\n${YELLOW}ðŸ“ Creating directory structure...${NC}"
    
    mkdir -p backend/app backend/utils backend/tests
    mkdir -p frontend/src/components frontend/src/services frontend/public
    
    echo -e "${GREEN}âœ… Directories created${NC}"
}

# Create backend files
create_backend_files() {
    echo -e "\n${YELLOW}ðŸ”§ Setting up backend...${NC}"
    
    # requirements.txt
    cat > backend/requirements.txt << 'EOF'
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0
python-dotenv==1.0.0
openai==1.3.8
httpx==0.25.2
aiofiles==23.2.1
redis==5.0.1
pytest==7.4.3
pytest-asyncio==0.21.1
EOF
    echo -e "${GREEN}âœ… requirements.txt created${NC}"
    
    # .env.example
    cat > backend/.env.example << 'EOF'
OPENAI_API_KEY=sk-your-key-here
PORT=8000
ENV=development
ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW=60
REDIS_URL=redis://localhost:6379/0
EOF
    echo -e "${GREEN}âœ… .env.example created${NC}"
    
    # Dockerfile
    cat > backend/Dockerfile << 'EOF'
FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health')"

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
EOF
    echo -e "${GREEN}âœ… Dockerfile created${NC}"
    
    # Create __init__.py files
    touch backend/app/__init__.py
    touch backend/utils/__init__.py
    touch backend/tests/__init__.py
    echo -e "${GREEN}âœ… Python package files created${NC}"
}

# Create frontend files
create_frontend_files() {
    echo -e "\n${YELLOW}âš›ï¸  Setting up frontend...${NC}"
    
    # package.json
    cat > frontend/package.json << 'EOF'
{
  "name": "ai-chatbot-frontend",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "axios": "^1.6.0",
    "typescript": "^5.0.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "react-scripts": "5.0.1"
  }
}
EOF
    echo -e "${GREEN}âœ… package.json created${NC}"
    
    # .env.local
    cat > frontend/.env.local << 'EOF'
REACT_APP_API_URL=http://localhost:8000
EOF
    echo -e "${GREEN}âœ… .env.local created${NC}"
    
    # public/index.html
    cat > frontend/public/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#667eea" />
    <meta name="description" content="AI Chatbot - Production-grade conversational AI" />
    <title>AI Chatbot</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>
EOF
    echo -e "${GREEN}âœ… index.html created${NC}"
}

# Setup Python virtual environment
setup_python_env() {
    echo -e "\n${YELLOW}ðŸ Setting up Python virtual environment...${NC}"
    
    cd backend
    python3 -m venv .venv
    
    # Activate venv and install dependencies
    if [ -f ".venv/bin/activate" ]; then
        source .venv/bin/activate
    else
        # Windows
        source .venv/Scripts/activate
    fi
    
    pip install --upgrade pip
    pip install -r requirements.txt
    
    cd ..
    echo -e "${GREEN}âœ… Python virtual environment created and dependencies installed${NC}"
}

# Setup Node.js environment
setup_node_env() {
    echo -e "\n${YELLOW}ðŸ“¦ Installing Node.js dependencies...${NC}"
    
    cd frontend
    npm install
    cd ..
    
    echo -e "${GREEN}âœ… Node.js dependencies installed${NC}"
}

# Create .gitignore
create_gitignore() {
    echo -e "\n${YELLOW}ðŸ“ Creating .gitignore...${NC}"
    
    cat > .gitignore << 'EOF'
# Virtual environments
.venv/
venv/
ENV/

# Environment variables
.env
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
dist/
build/

# Docker
.dockerignore
docker-compose.override.yml

# Logs
*.log
logs/

# Testing
.pytest_cache/
.coverage
htmlcov/

# OS
Thumbs.db
.DS_Store
EOF
    echo -e "${GREEN}âœ… .gitignore created${NC}"
}

# Final instructions
print_instructions() {
    echo -e "\n${GREEN}=========================================="
    echo "âœ… Project setup completed successfully!"
    echo "==========================================${NC}\n"
    
    echo -e "${YELLOW}ðŸ“‹ Next steps:${NC}\n"
    
    echo "1ï¸âƒ£  Backend Setup:"
    echo -e "   ${GREEN}cd backend${NC}"
    echo -e "   ${GREEN}source .venv/bin/activate  # or .venv\\Scripts\\activate on Windows${NC}"
    echo -e "   ${GREEN}cp .env.example .env${NC}"
    echo -e "   ${GREEN}# Edit .env and add your OPENAI_API_KEY${NC}"
    echo -e "   ${GREEN}uvicorn main:app --reload${NC}\n"
    
    echo "2ï¸âƒ£  Frontend Setup (in another terminal):"
    echo -e "   ${GREEN}cd frontend${NC}"
    echo -e "   ${GREEN}npm start${NC}\n"
    
    echo "3ï¸âƒ£  Access the app:"
    echo -e "   ${GREEN}Frontend: http://localhost:3000${NC}"
    echo -e "   ${GREEN}Backend: http://localhost:8000${NC}"
    echo -e "   ${GREEN}API Docs: http://localhost:8000/docs${NC}\n"
    
    echo "4ï¸âƒ£  Or run both with Docker:"
    echo -e "   ${GREEN}OPENAI_API_KEY=sk-xxx docker-compose up${NC}\n"
    
    echo -e "${YELLOW}ðŸ“š Documentation:${NC}"
    echo "   - README.md - Project overview"
    echo "   - DEPLOYMENT.md - Deployment instructions"
    echo ""
}

# Main execution
main() {
    check_prerequisites
    create_directories
    create_backend_files
    create_frontend_files
    create_gitignore
    setup_python_env
    setup_node_env
    print_instructions
}

# Run main function
main
